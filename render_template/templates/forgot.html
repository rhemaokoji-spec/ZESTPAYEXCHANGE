<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZestPay - Reset Password</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #000, #111);
      color: #fff;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .box {
      background: #1a1a1a;
      padding: 35px;
      border-radius: 15px;
      width: 380px;
      max-width: 100%;
      box-shadow: 0 6px 25px rgba(0,0,0,0.6);
      text-align: center;
      border: 1px solid rgba(212, 175, 55, 0.3);
      box-sizing: border-box;
    }
    h2 { margin-bottom: 15px; color: #d4af37; font-weight: 600; }
    input {
      width: 100%; padding: 12px; margin: 8px 0;
      border-radius: 8px; border: none; font-size: 15px;
      background: #111; color: #fff; outline: none;
      border: 1px solid rgba(212, 175, 55, 0.1);
      box-sizing: border-box;
    }
    input:focus { border: 1px solid #d4af37; }
    button {
      width: 100%; padding: 12px; margin-top: 12px;
      border-radius: 8px; border: none; font-size: 16px;
      background: #d4af37; color: #000; font-weight: bold;
      cursor: pointer; transition: 0.3s;
    }
    button:hover { background: #b8860b; }
    .hidden { display: none; }
    .msg { font-size: 14px; margin-top: 8px; }
    .success { color: #d4af37; }
    .error { color: #ff4d4d; }
    .warning { color: #ff9933; }

    /* Spinner for OTP verifying */
    .spinner {
      border: 4px solid rgba(255,255,255,0.2);
      border-top: 4px solid #d4af37;
      border-radius: 50%;
      width: 28px; height: 28px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* Input group */
    .input-group {
      position: relative;
    }
    .show-hide {
      position: absolute;
      right: 12px; top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #d4af37;
      font-size: 13px;
      user-select: none;
    }

    /* Strength meter */
    .strength {
      height: 6px;
      border-radius: 4px;
      margin-top: 4px;
      background: #333;
      overflow: hidden;
    }
    .strength-bar {
      height: 100%;
      width: 0;
      transition: width 0.3s;
    }

    /* OTP Input Boxes */
    .otp-container {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }
    .otp-box {
      width: 45px;
      height: 45px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      background: #111;
      border: 1px solid rgba(212, 175, 55, 0.1);
      border-radius: 8px;
      color: #fff;
      outline: none;
      transition: all 0.3s;
    }
    .otp-box:focus {
      border: 1px solid #d4af37;
      transform: scale(1.05);
    }

    /* Warning banner */
    .warning-banner {
      background: rgba(255, 153, 51, 0.2);
      border: 1px solid #ff9933;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #ff9933;
      display: flex;
      align-items: center;
    }
    .warning-icon {
      margin-right: 10px;
      font-size: 18px;
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      .box {
        padding: 25px;
        width: 100%;
      }
      h2 {
        font-size: 22px;
      }
      input, button {
        padding: 14px;
        font-size: 16px;
      }
      .otp-box {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      .show-hide {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="box">
    <!-- Warning Banner -->
    <div id="warning-banner" class="warning-banner hidden">
      <span class="warning-icon">⚠️</span>
      <span>You have an ongoing password reset process. Please complete it to continue.</span>
    </div>

    <!-- Step 1: Email -->
    <div id="step-email">
      <h2>Forgot Password</h2>
      <input type="email" id="email" placeholder="Enter your email" required>
      <button onclick="sendEmail()">Send OTP</button>
      <p id="msg1" class="msg"></p>
    </div>

    <!-- Step 2: OTP -->
    <div id="step-otp" class="hidden">
      <h2>Enter OTP</h2>
      <p id="otp-info" style="font-size:14px;color:#bbb;"></p>
      <div class="otp-container">
        <input type="text" class="otp-box" maxlength="1" oninput="handleOTPInput(0, this)" onkeydown="handleOTPBackspace(0, event)">
        <input type="text" class="otp-box" maxlength="1" oninput="handleOTPInput(1, this)" onkeydown="handleOTPBackspace(1, event)">
        <input type="text" class="otp-box" maxlength="1" oninput="handleOTPInput(2, this)" onkeydown="handleOTPBackspace(2, event)">
        <input type="text" class="otp-box" maxlength="1" oninput="handleOTPInput(3, this)" onkeydown="handleOTPBackspace(3, event)">
        <input type="text" class="otp-box" maxlength="1" oninput="handleOTPInput(4, this)" onkeydown="handleOTPBackspace(4, event)">
        <input type="text" class="otp-box" maxlength="1" oninput="handleOTPInput(5, this)" onkeydown="handleOTPBackspace(5, event)">
      </div>
      <div id="verify-status"></div>
      <button onclick="cancelReset()" style="background: #444; margin-top: 20px;">Cancel Reset</button>
    </div>

    <!-- Step 3: Reset Password -->
    <div id="step-reset" class="hidden">
      <h2>New Password</h2>
      <div class="input-group">
        <input type="password" id="new_pass" placeholder="New Password" required oninput="checkStrength(this.value)">
        <span class="show-hide" onclick="toggleShowHide('new_pass', this)">Show</span>
      </div>
      <div class="strength"><div id="strength-bar" class="strength-bar"></div></div>

      <div class="input-group">
        <input type="password" id="confirm_pass" placeholder="Confirm Password" required>
        <span class="show-hide" onclick="toggleShowHide('confirm_pass', this)">Show</span>
      </div>
      <button onclick="resetPass()">Change Password</button>
      <button onclick="cancelReset()" style="background: #444; margin-top: 10px;">Cancel Reset</button>
      <p id="msg3" class="msg"></p>
    </div>
  </div>

  <script>
    // Check for ongoing password reset process on page load
    document.addEventListener('DOMContentLoaded', function() {
      const resetInProgress = localStorage.getItem('passwordResetInProgress');
      const resetEmail = localStorage.getItem('passwordResetEmail');
      const resetStep = localStorage.getItem('passwordResetStep');
      
      if (resetInProgress === 'true') {
        // Show warning banner
        document.getElementById('warning-banner').classList.remove('hidden');
        
        // Set the email field if available
        if (resetEmail) {
          document.getElementById('email').value = resetEmail;
        }
        
        // Navigate to the appropriate step
        if (resetStep === 'otp') {
          document.getElementById('step-email').classList.add('hidden');
          document.getElementById('step-otp').classList.remove('hidden');
          document.getElementById('otp-info').innerText = "A code has been sent to: " + (resetEmail || 'your email');
          document.querySelectorAll('.otp-box')[0].focus();
        } else if (resetStep === 'reset') {
          document.getElementById('step-email').classList.add('hidden');
          document.getElementById('step-otp').classList.add('hidden');
          document.getElementById('step-reset').classList.remove('hidden');
        }
      }
    });

    // Prevent navigation away from the page if reset is in progress
    window.addEventListener('beforeunload', function(e) {
      if (localStorage.getItem('passwordResetInProgress') === 'true') {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Step 1: Send Email
    async function sendEmail(){
      const email = document.getElementById("email").value;
      try {
        let res = await fetch("/forgot", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({email})
        });
        let data = await res.json();
        document.getElementById("msg1").innerText = data.message;
        if(data.status === "ok"){
          // Store reset state in localStorage
          localStorage.setItem('passwordResetInProgress', 'true');
          localStorage.setItem('passwordResetEmail', email);
          localStorage.setItem('passwordResetStep', 'otp');
          
          document.getElementById("step-email").classList.add("hidden");
          document.getElementById("step-otp").classList.remove("hidden");
          document.getElementById("otp-info").innerText = "A code has been sent to: " + email;
          document.querySelectorAll('.otp-box')[0].focus();
        }
      } catch(e){
        document.getElementById("msg1").innerText = "❌ Error sending email.";
      }
    }

    // Handle OTP input
    function handleOTPInput(index, input) {
      // Only allow numbers
      input.value = input.value.replace(/[^0-9]/g, '');
      
      // Move to next input if current one is filled
      if (input.value.length === 1 && index < 5) {
        document.querySelectorAll('.otp-box')[index + 1].focus();
      }
      
      // Check if all boxes are filled
      checkAllOTPBoxes();
    }

    // Handle backspace in OTP boxes
    function handleOTPBackspace(index, event) {
      // If backspace is pressed and current box is empty, move to previous box
      if (event.key === 'Backspace' && index > 0 && document.querySelectorAll('.otp-box')[index].value === '') {
        document.querySelectorAll('.otp-box')[index - 1].focus();
      }
    }

    // Check if all OTP boxes are filled
    function checkAllOTPBoxes() {
      const otpBoxes = document.querySelectorAll('.otp-box');
      let allFilled = true;
      let otpValue = '';
      
      for (let i = 0; i < otpBoxes.length; i++) {
        if (otpBoxes[i].value === '') {
          allFilled = false;
          break;
        }
        otpValue += otpBoxes[i].value;
      }
      
      if (allFilled) {
        document.getElementById("verify-status").innerHTML = '<div class="spinner"></div><p>Verifying...</p>';
        setTimeout(async () => {
          try {
            let res = await fetch("/verify", {
              method: "POST",
              headers: {"Content-Type":"application/json"},
              body: JSON.stringify({otp: otpValue})
            });
            let data = await res.json();
            if(data.status === "ok"){
              // Update reset step in localStorage
              localStorage.setItem('passwordResetStep', 'reset');
              
              document.getElementById("verify-status").innerHTML = '<p class="success">✅ Verified successfully!</p>';
              setTimeout(()=>{
                document.getElementById("step-otp").classList.add("hidden");
                document.getElementById("step-reset").classList.remove("hidden");
              }, 1500);
            } else {
              document.getElementById("verify-status").innerHTML = '<p class="error">❌ Invalid code!</p>';
              // Clear all OTP boxes
              otpBoxes.forEach(box => box.value = '');
              // Focus on first box
              otpBoxes[0].focus();
            }
          } catch(e){
            document.getElementById("verify-status").innerHTML = '<p class="error">❌ Error verifying!</p>';
          }
        }, 3000);
      }
    }

    // Step 3: Reset Password
    async function resetPass(){
      const newPass = document.getElementById("new_pass").value;
      const confirmPass = document.getElementById("confirm_pass").value;
      if(newPass !== confirmPass){
        document.getElementById("msg3").innerText = "❌ Passwords do not match!";
        return;
      }
      try {
        let res = await fetch("/reset", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({new_password:newPass, confirm_password:confirmPass})
        });
        let data = await res.json();
        if(data.status === "ok"){
          // Clear reset state from localStorage
          localStorage.removeItem('passwordResetInProgress');
          localStorage.removeItem('passwordResetEmail');
          localStorage.removeItem('passwordResetStep');
          
          document.getElementById("msg3").innerText = "✅ Password changed!";
          setTimeout(()=> window.location.href="/login", 2000);
        } else {
          document.getElementById("msg3").innerText = data.message;
        }
      } catch(e){
        document.getElementById("msg3").innerText = "❌ Error resetting password.";
      }
    }

    // Cancel password reset process
    function cancelReset() {
      if (confirm("Are you sure you want to cancel the password reset process? You will need to start over if you change your mind.")) {
        // Clear reset state from localStorage
        localStorage.removeItem('passwordResetInProgress');
        localStorage.removeItem('passwordResetEmail');
        localStorage.removeItem('passwordResetStep');
        
        // Redirect to login page
        window.location.href = "/login";
      }
    }

    // Show/Hide Password (explicit)
    function toggleShowHide(id, el){
      const input = document.getElementById(id);
      if(input.type === "password"){
        input.type = "text";
        el.innerText = "Hide";
      } else {
        input.type = "password";
        el.innerText = "Show";
      }
    }

    // Password strength checker
    function checkStrength(pass){
      const bar = document.getElementById("strength-bar");
      let strength = 0;
      if(pass.length >= 6) strength++;
      if(/[A-Z]/.test(pass)) strength++;
      if(/[0-9]/.test(pass)) strength++;
      if(/[^A-Za-z0-9]/.test(pass)) strength++;

      let width = ["0%","25%","50%","75%","100%"][strength];
      let colors = ["#333","#ff4d4d","#ff9933","#f9d342","#d4af37"];
      bar.style.width = width;
      bar.style.background = colors[strength];
    }
  </script>
</body>
</html>